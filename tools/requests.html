<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Review Requests</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --bg: #020617;
      --panel: #0f172a;
      --text: #e2e8f0;
      --text-muted: #94a3b8;
      --accent: #22c55e;
      --accent-hover: #16a34a;
      --border: #1e293b;
      --shadow: rgba(0, 0, 0, 0.5);
      --danger: #ef4444;
      --warning: #f59e0b;
    }

    html.light {
      --bg: #f8fafc;
      --panel: #ffffff;
      --text: #1e293b;
      --text-muted: #64748b;
      --accent: #16a34a;
      --accent-hover: #15803d;
      --border: #e2e8f0;
      --shadow: rgba(0, 0, 0, 0.1);
    }

    body {
      min-height: 100vh;
      background: var(--bg);
      color: var(--text);
      font-family: system-ui, -apple-system, sans-serif;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 30px;
      background: var(--panel);
      border-bottom: 1px solid var(--border);
    }

    .logo {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--accent);
      text-decoration: none;
    }

    .back-btn {
      color: var(--text-muted);
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .back-btn:hover {
      color: var(--text);
    }

    .container {
      max-width: 1000px;
      margin: 0 auto;
      padding: 30px;
    }

    .page-title {
      font-size: 2rem;
      margin-bottom: 30px;
    }

    .requests-list {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .request-card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 25px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .request-card:hover {
      border-color: var(--accent);
      transform: translateX(5px);
    }

    .request-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 15px;
    }

    .request-title {
      font-size: 1.3rem;
      font-weight: 600;
    }

    .request-type {
      display: inline-block;
      background: var(--bg);
      color: var(--text-muted);
      padding: 5px 15px;
      border-radius: 20px;
      font-size: 0.8rem;
      text-transform: uppercase;
    }

    .request-price {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--accent);
    }

    .request-meta {
      display: flex;
      gap: 20px;
      color: var(--text-muted);
      font-size: 0.9rem;
      flex-wrap: wrap;
    }

    .status-badge {
      display: inline-block;
      padding: 5px 15px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: uppercase;
    }

    .status-pending {
      background: rgba(245, 158, 11, 0.2);
      color: var(--warning);
    }

    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.9);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }

    .modal-overlay.show {
      display: flex;
    }

    .modal {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 30px;
      max-width: 600px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      position: relative;
    }

    .modal-title {
      font-size: 1.5rem;
      margin-bottom: 25px;
      padding-right: 40px;
    }

    .detail-group {
      margin-bottom: 20px;
    }

    .detail-label {
      font-size: 0.8rem;
      color: var(--text-muted);
      text-transform: uppercase;
      margin-bottom: 5px;
    }

    .detail-value {
      font-size: 1.1rem;
      word-break: break-word;
    }

    .detail-value.description {
      line-height: 1.5;
      color: var(--text-muted);
    }

    .links-box {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .link-item {
      margin-bottom: 15px;
    }

    .link-label {
      font-size: 0.8rem;
      color: var(--text-muted);
      text-transform: uppercase;
      margin-bottom: 5px;
    }

    .link-url {
      font-family: monospace;
      font-size: 0.85rem;
      color: var(--accent);
      word-break: break-all;
      background: var(--panel);
      padding: 10px;
      border-radius: 8px;
      display: block;
      text-decoration: none;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      font-size: 0.85rem;
      color: var(--text-muted);
      margin-bottom: 8px;
      text-transform: uppercase;
    }

    .form-input {
      width: 100%;
      padding: 15px;
      background: var(--bg);
      border: 2px solid var(--border);
      border-radius: 12px;
      color: var(--text);
      font-size: 1rem;
    }

    .form-input:focus {
      outline: none;
      border-color: var(--accent);
    }

    .help-text {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-top: 5px;
    }

    .actions {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-top: 25px;
    }

    .btn {
      padding: 15px;
      border: none;
      border-radius: 12px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-approve {
      background: var(--accent);
      color: white;
    }

    .btn-reject {
      background: var(--danger);
      color: white;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .close-btn {
      position: absolute;
      top: 20px;
      right: 20px;
      background: none;
      border: none;
      color: var(--text-muted);
      font-size: 2rem;
      cursor: pointer;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
    }

    .close-btn:hover {
      background: var(--bg);
      color: var(--text);
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-muted);
    }

    .empty-icon {
      font-size: 4rem;
      margin-bottom: 20px;
    }

    .access-denied {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 20px;
    }

    .access-card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 50px;
      max-width: 400px;
    }

    .access-icon {
      font-size: 4rem;
      margin-bottom: 20px;
    }

    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid var(--border);
      border-radius: 50%;
      border-top-color: var(--accent);
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .toast {
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: var(--panel);
      border: 1px solid var(--border);
      padding: 15px 30px;
      border-radius: 12px;
      box-shadow: 0 10px 40px var(--shadow);
      opacity: 0;
      transition: all 0.3s;
      z-index: 2000;
    }

    .toast.show {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }

    .toast.success { border-color: var(--accent); }
    .toast.error { border-color: var(--danger); }

    @media (max-width: 768px) {
      .actions { grid-template-columns: 1fr; }
      .request-header { flex-direction: column; gap: 10px; }
    }
  </style>
</head>
<body>
  <div id="content">
    <div class="access-denied">
      <div class="access-card">
        <div class="loading"></div>
        <p style="margin-top: 20px;">Checking permissions...</p>
      </div>
    </div>
  </div>
  
  <div class="toast" id="toast"></div>

  <div class="modal-overlay" id="reviewModal">
    <div class="modal">
      <button class="close-btn" onclick="closeModal()">√ó</button>
      <h2 class="modal-title">Review Request</h2>
      <div id="modalContent"></div>
    </div>
  </div>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    const supabase = createClient(
      "https://mdymxbgwhauapvphscrr.supabase.co",
      "sb_publishable_nOrq936I1SMh4v21KzE2og_tAEbcAzK"
    );

    function getCookie(name) {
      const value = document.cookie.split("; ").find(r => r.startsWith(name + "="))?.split("=")[1];
      return value ? decodeURIComponent(value) : null;
    }

    function applyTheme() {
      if (getCookie("theme") === "light") {
        document.documentElement.classList.add("light");
      }
    }
    applyTheme();

    const uuid = getCookie("uuid");
    const username = getCookie("username");
    const content = document.getElementById("content");
    
    let currentUser = null;
    let requests = [];
    let selectedRequest = null;
    let isProcessing = false;

    if (!uuid || !username) {
      window.location.href = "/login.html";
      throw new Error("Not logged in");
    }

    async function init() {
      try {
        const { data: userData, error: userError } = await supabase
          .from("users")
          .select("uuid, username, rank")
          .eq("uuid", uuid)
          .single();

        if (userError || !userData) {
          showAccessDenied("Error loading user data.");
          return;
        }

        currentUser = userData;
        const userRank = (userData.rank || "").toLowerCase();
        
        if (!["manager", "owner"].includes(userRank)) {
          showAccessDenied("You need to be a manager or owner to access this page.");
          return;
        }

        renderPage();
        await loadRequests();
        
      } catch (err) {
        console.error("Init error:", err);
        showAccessDenied("An error occurred.");
      }
    }

    function showAccessDenied(message) {
      content.innerHTML = `
        <div class="access-denied">
          <div class="access-card">
            <div class="access-icon">üö´</div>
            <h1>Access Denied</h1>
            <p style="color: var(--text-muted); margin: 15px 0;">${escapeHtml(message)}</p>
            <a href="/tools/marketplace.html" style="display: inline-block; padding: 14px 32px; background: var(--accent); color: white; text-decoration: none; border-radius: 8px; font-weight: 600; margin-top: 10px;">Back to Marketplace</a>
          </div>
        </div>
      `;
    }

    function renderPage() {
      content.innerHTML = `
        <div class="header">
          <a href="/tools/marketplace.html" class="back-btn">‚Üê Back to Marketplace</a>
          <a href="/tools/marketplace.html" class="logo">üè™ Marketplace</a>
          <div style="color: var(--text-muted); font-size: 0.9rem;">${escapeHtml(username)}</div>
        </div>
        
        <div class="container">
          <h1 class="page-title">Pending Requests</h1>
          <div class="requests-list" id="requestsList">
            <div class="empty-state">
              <div class="loading" style="margin: 0 auto 20px;"></div>
              <p>Loading requests...</p>
            </div>
          </div>
        </div>
      `;
    }

    async function loadRequests() {
      try {
        const { data, error } = await supabase
          .from("requests")
          .select("*, seller:seller_uuid(name)")
          .eq("status", "pending")
          .order("created_at", { ascending: false });

        if (error) throw error;

        requests = data || [];
        renderRequests();
        
      } catch (err) {
        console.error("Load requests error:", err);
        const list = document.getElementById("requestsList");
        if (list) {
          list.innerHTML = `
            <div class="empty-state">
              <div class="empty-icon">‚ö†Ô∏è</div>
              <h2>Error loading requests</h2>
              <p>${escapeHtml(err.message)}</p>
              <button onclick="location.reload()" style="margin-top: 20px; padding: 10px 20px; background: var(--accent); color: white; border: none; border-radius: 8px; cursor: pointer;">Retry</button>
            </div>
          `;
        }
      }
    }

    function renderRequests() {
      const list = document.getElementById("requestsList");
      if (!list) return;
      
      if (requests.length === 0) {
        list.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">üéâ</div>
            <h2>No pending requests</h2>
            <p>All caught up!</p>
          </div>
        `;
        return;
      }

      list.innerHTML = requests.map(req => `
        <div class="request-card" onclick='openReviewModal(${JSON.stringify(req.id)})'>
          <div class="request-header">
            <div>
              <h3 class="request-title">${escapeHtml(req.title)}</h3>
              <span class="request-type">${req.product_type}</span>
            </div>
            <span class="request-price">$${parseFloat(req.price).toFixed(2)}</span>
          </div>
          <div class="request-meta">
            <span>By: ${escapeHtml(req.seller?.name || "Unknown")}</span>
            <span>${new Date(req.created_at).toLocaleDateString()}</span>
            <span class="status-badge status-pending">Pending</span>
          </div>
        </div>
      `).join("");
    }

    window.openReviewModal = function(requestId) {
      selectedRequest = requests.find(r => r.id === requestId);
      if (!selectedRequest) {
        showToast("Request not found", "error");
        return;
      }

      const modalContent = document.getElementById("modalContent");
      let linksHtml = "";
      
      if (selectedRequest.drive_link) {
        try {
          const links = JSON.parse(selectedRequest.drive_link);
          
          if (selectedRequest.product_type === "game") {
            linksHtml = `
              <div class="links-box">
                <div class="link-item">
                  <div class="link-label">Game File (.sb3)</div>
                  <a href="${escapeHtml(links.game)}" target="_blank" class="link-url">${escapeHtml(links.game)}</a>
                </div>
                <div class="link-item">
                  <div class="link-label">Icon Image</div>
                  <a href="${escapeHtml(links.icon)}" target="_blank" class="link-url">${escapeHtml(links.icon)}</a>
                </div>
              </div>
            `;
          } else {
            linksHtml = `
              <div class="links-box">
                <div class="link-item">
                  <div class="link-label">Product Image</div>
                  <a href="${escapeHtml(links.image)}" target="_blank" class="link-url">${escapeHtml(links.image)}</a>
                </div>
                <div class="link-item">
                  <div class="link-label">Stock Quantity</div>
                  <div class="detail-value">${links.stock || 1} units</div>
                </div>
              </div>
            `;
          }
        } catch (e) {
          linksHtml = `<div class="detail-value" style="color: var(--danger);">Invalid link data</div>`;
        }
      }

      const isGame = selectedRequest.product_type === "game";

      modalContent.innerHTML = `
        <div class="detail-group">
          <div class="detail-label">Title</div>
          <div class="detail-value">${escapeHtml(selectedRequest.title)}</div>
        </div>
        
        <div class="detail-group">
          <div class="detail-label">Price</div>
          <div class="detail-value">$${parseFloat(selectedRequest.price).toFixed(2)}</div>
        </div>
        
        <div class="detail-group">
          <div class="detail-label">Seller</div>
          <div class="detail-value">${escapeHtml(selectedRequest.seller?.name || "Unknown")}</div>
        </div>
        
        <div class="detail-group">
          <div class="detail-label">Product Type</div>
          <div class="detail-value">${selectedRequest.product_type}</div>
        </div>
        
        <div class="detail-group">
          <div class="detail-label">Description</div>
          <div class="detail-value description">${escapeHtml(selectedRequest.description) || "No description"}</div>
        </div>
        
        ${linksHtml}
        
        <hr style="border: none; border-top: 1px solid var(--border); margin: 25px 0;">
        
        <div class="form-group">
          <label class="form-label">Image Filename *</label>
          <input type="text" class="form-input" id="imageFilename" placeholder="e.g., product-123.png" required>
          <div class="help-text">Saved as: /images/[filename]</div>
        </div>
        
        ${isGame ? `
        <div class="form-group">
          <label class="form-label">Game Filename *</label>
          <input type="text" class="form-input" id="gameFilename" placeholder="e.g., my-game.html" required>
          <div class="help-text">Saved as: /games/[filename]</div>
        </div>
        ` : ""}
        
        <div class="actions">
          <button class="btn btn-reject" onclick="processRequest('rejected')" id="rejectBtn">Reject</button>
          <button class="btn btn-approve" onclick="processRequest('approved')" id="approveBtn">Approve & List</button>
        </div>
      `;
      
      document.getElementById("reviewModal").classList.add("show");
    };

    window.closeModal = function() {
      document.getElementById("reviewModal").classList.remove("show");
      selectedRequest = null;
      isProcessing = false;
    };

    window.processRequest = async function(status) {
      if (!selectedRequest || isProcessing) return;
      
      const imageFilename = document.getElementById("imageFilename")?.value.trim();
      const gameFilename = document.getElementById("gameFilename")?.value.trim();
      
      if (status === "approved") {
        if (!imageFilename) {
          showToast("Image filename is required", "error");
          return;
        }
        if (selectedRequest.product_type === "game" && !gameFilename) {
          showToast("Game filename is required", "error");
          return;
        }
      }

      isProcessing = true;
      const approveBtn = document.getElementById("approveBtn");
      const rejectBtn = document.getElementById("rejectBtn");
      
      if (approveBtn) { approveBtn.disabled = true; approveBtn.textContent = "Processing..."; }
      if (rejectBtn) rejectBtn.disabled = true;

      try {
        if (status === "approved") {
          // Determine stock: -1 for games (infinite), actual number for physical
          let stock = -1;
          if (selectedRequest.product_type === "physical" && selectedRequest.drive_link) {
            try {
              const links = JSON.parse(selectedRequest.drive_link);
              stock = parseInt(links.stock) || 1;
            } catch (e) {
              stock = 1;
            }
          }

          const { error: marketError } = await supabase.from("marketplace").insert({
            seller_uuid: selectedRequest.seller_uuid,
            title: selectedRequest.title,
            price: selectedRequest.price,
            description: selectedRequest.description,
            product_type: selectedRequest.product_type,
            image_path: `/images/${imageFilename}`,
            game_path: selectedRequest.product_type === "game" && gameFilename ? `/games/${gameFilename}` : null,
            stock: stock
          });

          if (marketError) throw new Error("Failed to create listing: " + marketError.message);
        }

        const { error: updateError } = await supabase
          .from("requests")
          .update({ status: status })
          .eq("id", selectedRequest.id);

        if (updateError) throw new Error("Failed to update request: " + updateError.message);

        showToast(`Request ${status} successfully!`, "success");
        closeModal();
        requests = requests.filter(r => r.id !== selectedRequest.id);
        renderRequests();
        
      } catch (err) {
        console.error("Process error:", err);
        showToast(err.message || "Error processing request", "error");
        if (approveBtn) { approveBtn.disabled = false; approveBtn.textContent = "Approve & List"; }
        if (rejectBtn) rejectBtn.disabled = false;
        isProcessing = false;
      }
    };

    function escapeHtml(text) {
      if (!text) return "";
      const div = document.createElement("div");
      div.textContent = text;
      return div.innerHTML;
    }

    function showToast(message, type) {
      const toast = document.getElementById("toast");
      toast.textContent = message;
      toast.className = `toast ${type}`;
      setTimeout(() => toast.classList.add("show"), 10);
      setTimeout(() => toast.classList.remove("show"), 3000);
    }

    document.getElementById("reviewModal")?.addEventListener("click", (e) => {
      if (e.target === document.getElementById("reviewModal")) closeModal();
    });

    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") closeModal();
    });

    init();
  </script>
</body>
</html>