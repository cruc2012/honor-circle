<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>SiteBuilder Pro</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --bg: #020617;
      --panel: #0f172a;
      --text: #e2e8f0;
      --text-muted: #94a3b8;
      --accent: #22c55e;
      --accent-hover: #16a34a;
      --border: #1e293b;
      --input-bg: #1e293b;
      --shadow: rgba(0, 0, 0, 0.5);
      --hover-bg: #1e293b;
      --danger: #ef4444;
      --danger-hover: #dc2626;
      --tab-active: #1e293b;
    }

    html.light {
      --bg: #f8fafc;
      --panel: #ffffff;
      --text: #1e293b;
      --text-muted: #64748b;
      --accent: #16a34a;
      --accent-hover: #15803d;
      --border: #e2e8f0;
      --input-bg: #f1f5f9;
      --shadow: rgba(0, 0, 0, 0.1);
      --hover-bg: #e2e8f0;
      --danger: #dc2626;
      --danger-hover: #b91c1c;
      --tab-active: #e2e8f0;
    }

    body {
      min-height: 100vh;
      background: var(--bg);
      color: var(--text);
      font-family: system-ui, -apple-system, sans-serif;
      transition: background 0.3s, color 0.3s;
      overflow-x: hidden;
    }

    /* Login Required */
    .login-required {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .login-card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 50px 40px;
      text-align: center;
      max-width: 400px;
      width: 100%;
      box-shadow: 0 10px 40px var(--shadow);
    }

    .login-icon {
      font-size: 4rem;
      margin-bottom: 20px;
    }

    .login-btn {
      display: inline-block;
      padding: 14px 32px;
      background: var(--accent);
      color: white;
      text-decoration: none;
      border-radius: 8px;
      font-weight: 600;
      margin-top: 15px;
      transition: all 0.2s;
      border: none;
      cursor: pointer;
    }

    .login-btn:hover {
      background: var(--accent-hover);
      transform: translateY(-2px);
    }

    /* Main Builder Layout */
    #app {
      min-height: 100vh;
      display: grid;
      grid-template-columns: 280px 1fr 320px;
      grid-template-rows: 60px 1fr;
      grid-template-areas: 
        "header header header"
        "sidebar canvas properties";
    }

    /* Header */
    .header {
      grid-area: header;
      background: var(--panel);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
      z-index: 100;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .logo {
      font-size: 1.3rem;
      font-weight: 700;
      color: var(--accent);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .site-title-link {
      color: var(--text);
      text-decoration: none;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      padding: 8px 16px;
      border-radius: 8px;
      transition: all 0.2s;
    }

    .site-title-link:hover {
      background: var(--hover-bg);
      color: var(--accent);
    }

    .header-actions {
      display: flex;
      gap: 10px;
    }

    .btn {
      padding: 8px 16px;
      background: var(--input-bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 6px;
      text-decoration: none;
    }

    .btn:hover {
      background: var(--hover-bg);
      transform: translateY(-1px);
    }

    .btn-primary {
      background: var(--accent);
      border-color: var(--accent);
      color: white;
    }

    .btn-primary:hover {
      background: var(--accent-hover);
    }

    .btn-danger {
      background: var(--danger);
      border-color: var(--danger);
      color: white;
    }

    .btn-danger:hover {
      background: var(--danger-hover);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Sidebar - Components & Pages */
    .sidebar {
      grid-area: sidebar;
      background: var(--panel);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .sidebar-tabs {
      display: flex;
      border-bottom: 1px solid var(--border);
    }

    .sidebar-tab {
      flex: 1;
      padding: 12px;
      background: transparent;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 600;
      transition: all 0.2s;
    }

    .sidebar-tab:hover {
      color: var(--text);
      background: var(--hover-bg);
    }

    .sidebar-tab.active {
      color: var(--accent);
      background: var(--bg);
      border-bottom: 2px solid var(--accent);
    }

    .sidebar-content {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }

    .sidebar-title {
      font-size: 0.85rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 15px;
    }

    .component-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
    }

    .component-item {
      background: var(--bg);
      border: 2px solid var(--border);
      border-radius: 12px;
      padding: 15px;
      text-align: center;
      cursor: grab;
      transition: all 0.2s;
      user-select: none;
    }

    .component-item:hover {
      border-color: var(--accent);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px var(--shadow);
    }

    .component-item:active {
      cursor: grabbing;
    }

    .component-icon {
      font-size: 1.8rem;
      margin-bottom: 8px;
    }

    .component-label {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    /* Page List in Sidebar */
    .page-list {
      list-style: none;
    }

    .page-list-item {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: move;
      transition: all 0.2s;
    }

    .page-list-item:hover {
      border-color: var(--accent);
    }

    .page-list-item.active {
      border-color: var(--accent);
      background: rgba(34, 197, 94, 0.1);
    }

    .page-list-item.home {
      border-left: 3px solid var(--accent);
    }

    .page-list-item.dragging {
      opacity: 0.5;
    }

    .page-list-name {
      flex: 1;
      background: none;
      border: none;
      color: var(--text);
      font-size: 0.95rem;
      cursor: text;
    }

    .page-list-actions {
      display: flex;
      gap: 5px;
    }

    .page-action-btn {
      padding: 4px 8px;
      background: var(--panel);
      border: 1px solid var(--border);
      color: var(--text);
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.8rem;
    }

    .page-action-btn:hover {
      background: var(--accent);
      color: white;
    }

    .page-action-btn.active {
      background: var(--accent);
      color: white;
    }

    .add-page-btn {
      width: 100%;
      padding: 12px;
      background: var(--accent);
      border: none;
      color: white;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      margin-top: 10px;
    }

    .add-page-btn:hover {
      background: var(--accent-hover);
    }

    /* Canvas Area */
    .canvas-container {
      grid-area: canvas;
      background: var(--bg);
      position: relative;
      overflow: auto;
      padding: 40px;
    }

    .canvas {
      min-height: 800px;
      max-width: 1200px;
      margin: 0 auto;
      background: var(--panel);
      border: 2px dashed var(--border);
      border-radius: 16px;
      padding: 40px;
      position: relative;
      transition: all 0.3s;
    }

    .canvas.drag-over {
      border-color: var(--accent);
      background: rgba(34, 197, 94, 0.05);
    }

    .canvas-empty {
      text-align: center;
      padding: 100px 20px;
      color: var(--text-muted);
    }

    .canvas-empty-icon {
      font-size: 4rem;
      margin-bottom: 20px;
      opacity: 0.5;
    }

    /* Element Wrapper for Side-by-Side */
    .element-wrapper {
      position: relative;
      margin-bottom: 20px;
      display: flex;
      gap: 20px;
      align-items: flex-start;
    }

    .element-wrapper.dragging {
      opacity: 0.5;
    }

    .element-wrapper .canvas-element {
      flex: 1;
      margin-bottom: 0;
    }

    .element-wrapper .canvas-element.locked {
      flex: none;
      width: 100%;
    }

    .element-wrapper .drag-handle {
      position: absolute;
      left: -25px;
      top: 50%;
      transform: translateY(-50%);
      width: 20px;
      height: 40px;
      background: var(--border);
      border-radius: 4px;
      cursor: grab;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-muted);
      font-size: 0.8rem;
      z-index: 10;
    }

    .element-wrapper .drag-handle:active {
      cursor: grabbing;
    }

    /* Side element styling */
    .side-element-container {
      display: flex;
      gap: 20px;
      flex: 1;
    }

    .side-element-container .canvas-element {
      flex: 1;
    }

    .delete-side-btn {
      position: absolute;
      right: -30px;
      top: 50%;
      transform: translateY(-50%);
      width: 24px;
      height: 24px;
      background: var(--danger);
      border: none;
      color: white;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.9rem;
      z-index: 10;
    }

    .delete-side-btn:hover {
      background: var(--danger-hover);
    }

    /* Dropped Elements */
    .canvas-element {
      position: relative;
      border: 2px solid transparent;
      border-radius: 8px;
      transition: all 0.2s;
      overflow: visible;
      min-width: 200px;
      min-height: 50px;
      background: var(--panel);
    }

    .canvas-element:hover {
      border-color: var(--border);
    }

    .canvas-element.selected {
      border-color: var(--accent);
      box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.1);
    }

    /* Only show SE resize handle */
    .resize-handle {
      position: absolute;
      width: 12px;
      height: 12px;
      background: var(--accent);
      border-radius: 50%;
      z-index: 10;
      display: none;
    }

    .canvas-element.selected .resize-handle.se {
      display: block;
    }

    .resize-handle.se {
      bottom: -6px;
      right: -6px;
      cursor: se-resize;
    }

    .element-actions {
      position: absolute;
      top: -35px;
      right: 0;
      display: flex;
      gap: 5px;
      z-index: 20;
      background: var(--panel);
      padding: 5px;
      border-radius: 8px;
      border: 1px solid var(--border);
      box-shadow: 0 2px 8px var(--shadow);
    }

    .element-action-btn {
      width: 28px;
      height: 28px;
      border-radius: 6px;
      border: 1px solid var(--border);
      background: var(--bg);
      color: var(--text);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.9rem;
      transition: all 0.2s;
    }

    .element-action-btn:hover {
      background: var(--hover-bg);
    }

    .element-action-btn.delete {
      background: var(--danger);
      border-color: var(--danger);
      color: white;
    }

    .element-action-btn.delete:hover {
      background: var(--danger-hover);
    }

    .element-content {
      padding: 20px;
      width: 100%;
      height: 100%;
    }

    /* Element Types */
    .el-heading h1, .el-heading h2, .el-heading h3 {
      margin: 0;
    }

    .el-text p {
      margin: 0;
      line-height: 1.6;
    }

    .el-text a {
      color: var(--accent);
      text-decoration: underline;
    }

    .el-button {
      text-align: center;
    }

    .el-button .btn-preview {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      cursor: pointer;
      text-decoration: none;
      display: inline-block;
      font-weight: 600;
      transition: all 0.2s;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .el-button .btn-preview:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.15);
    }

    .el-image img {
      max-width: 100%;
      display: block;
      margin: 0 auto;
    }

    .el-card {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
    }

    .el-hero {
      text-align: center;
      padding: 60px 20px;
      background: linear-gradient(135deg, var(--panel) 0%, var(--bg) 100%);
      border-radius: 16px;
    }

    .el-hero h1 {
      font-size: 2.5rem;
      margin-bottom: 20px;
    }

    .el-hero p {
      font-size: 1.2rem;
      margin-bottom: 30px;
    }

    .el-iframe iframe {
      width: 100%;
      height: 100%;
      border: none;
      border-radius: 8px;
    }

    .el-footer {
      background: var(--bg);
      border-top: 1px solid var(--border);
      padding: 40px 20px;
      text-align: center;
      margin-top: 40px;
    }

    /* Properties Panel */
    .properties {
      grid-area: properties;
      background: var(--panel);
      border-left: 1px solid var(--border);
      padding: 20px;
      overflow-y: auto;
    }

    .properties-title {
      font-size: 0.85rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 20px;
    }

    .property-group {
      margin-bottom: 20px;
      padding-bottom: 20px;
      border-bottom: 1px solid var(--border);
    }

    .property-label {
      display: block;
      font-size: 0.85rem;
      color: var(--text-muted);
      margin-bottom: 8px;
    }

    .property-input,
    .property-select,
    .property-textarea {
      width: 100%;
      padding: 10px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-size: 0.95rem;
      transition: border-color 0.2s;
    }

    .property-input:focus,
    .property-select:focus,
    .property-textarea:focus {
      outline: none;
      border-color: var(--accent);
    }

    .property-textarea {
      min-height: 100px;
      resize: vertical;
      font-family: inherit;
    }

    .property-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .color-picker-wrapper {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .color-picker {
      width: 50px;
      height: 40px;
      border: 1px solid var(--border);
      border-radius: 8px;
      cursor: pointer;
      background: none;
    }

    .no-selection {
      text-align: center;
      color: var(--text-muted);
      padding: 40px 20px;
    }

    .link-editor {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 15px;
      margin-top: 10px;
    }

    /* Publish URL Display */
    .publish-url {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px;
      margin-top: 15px;
      word-break: break-all;
      font-size: 0.85rem;
    }

    .publish-url a {
      color: var(--accent);
      text-decoration: none;
    }

    .publish-url a:hover {
      text-decoration: underline;
    }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: var(--panel);
      border: 1px solid var(--border);
      padding: 15px 30px;
      border-radius: 12px;
      box-shadow: 0 10px 40px var(--shadow);
      opacity: 0;
      transition: all 0.3s;
      z-index: 1000;
    }

    .toast.show {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }

    .toast.success {
      border-color: var(--accent);
    }

    .toast.error {
      border-color: var(--danger);
    }

    /* Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 16px;
      max-width: 700px;
      width: 100%;
      max-height: 80vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .modal-header {
      padding: 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-title {
      font-size: 1.2rem;
      font-weight: 600;
    }

    .modal-close {
      background: none;
      border: none;
      color: var(--text-muted);
      font-size: 1.5rem;
      cursor: pointer;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
      transition: all 0.2s;
    }

    .modal-close:hover {
      background: var(--bg);
      color: var(--text);
    }

    .modal-body {
      padding: 20px;
      overflow-y: auto;
      flex: 1;
    }

    .modal-footer {
      padding: 20px;
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    /* Preview Mode */
    .preview-mode #app {
      grid-template-columns: 1fr;
      grid-template-areas: 
        "header"
        "canvas";
    }

    .preview-mode .sidebar,
    .preview-mode .properties {
      display: none;
    }

    .preview-mode .canvas {
      border: none;
      max-width: 100%;
      min-height: 100vh;
    }

    .preview-mode .canvas-element {
      border: none !important;
      box-shadow: none !important;
    }

    .preview-mode .resize-handle,
    .preview-mode .element-actions,
    .preview-mode .drag-handle,
    .preview-mode .delete-side-btn {
      display: none !important;
    }

    /* Watermark */
    .watermark {
      position: fixed;
      bottom: 10px;
      right: 10px;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 5px 10px;
      border-radius: 4px;
      font-size: 0.75rem;
      z-index: 9999;
      pointer-events: none;
    }

    .preview-mode .watermark {
      display: block;
    }

    /* Responsive */
    @media (max-width: 1024px) {
      #app {
        grid-template-columns: 240px 1fr 280px;
      }
    }

    @media (max-width: 768px) {
      #app {
        grid-template-columns: 1fr;
        grid-template-rows: 60px auto 1fr auto;
        grid-template-areas: 
          "header"
          "sidebar"
          "canvas"
          "properties";
      }

      .sidebar {
        border-right: none;
        border-bottom: 1px solid var(--border);
        max-height: 200px;
      }

      .properties {
        border-left: none;
        border-top: 1px solid var(--border);
      }

      .element-wrapper {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <div id="content"></div>
  <div class="toast" id="toast"></div>
  <div class="watermark" style="display: none;">Built using hc.curtishub.com</div>
  
  <div class="modal-overlay" id="codeModal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Export HTML</h3>
        <button class="modal-close" onclick="closeModal()">&times;</button>
      </div>
      <div class="modal-body">
        <textarea class="property-textarea" id="codeOutput" readonly style="min-height: 400px; font-family: monospace; font-size: 0.85rem;"></textarea>
      </div>
      <div class="modal-footer">
        <button class="btn" onclick="copyCode()">Copy to Clipboard</button>
        <button class="btn btn-primary" onclick="closeModal()">Close</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    // Use the service role key for admin operations (publish)
    // Note: In production, you should use a secure backend API for this
    const supabaseUrl = "https://mdymxbgwhauapvphscrr.supabase.co";
    const supabaseKey = "sb_publishable_nOrq936I1SMh4v21KzE2og_tAEbcAzK";
    
    const supabase = createClient(supabaseUrl, supabaseKey);

    function getCookie(name) {
      const value = document.cookie.split("; ").find(r => r.startsWith(name + "="))?.split("=")[1];
      return value ? decodeURIComponent(value) : null;
    }

    function setCookie(name, value, days = 365) {
      const expires = new Date(Date.now() + days * 864e5).toUTCString();
      document.cookie = name + '=' + encodeURIComponent(value) + '; expires=' + expires + '; path=/';
    }

    // Listen for theme changes from parent iframe
    window.addEventListener('message', (e) => {
      if (e.data && e.data.theme) {
        if (e.data.theme === 'light') {
          document.documentElement.classList.add('light');
        } else {
          document.documentElement.classList.remove('light');
        }
      }
    });

    const uuid = getCookie("uuid");
    const username = getCookie("username");
    const content = document.getElementById("content");

    const components = [
      { type: 'heading', icon: 'üìù', label: 'Heading', default: { tag: 'h2', text: 'Heading Text', align: 'left', size: '2rem', color: '#e2e8f0', width: '100%', height: 'auto' } },
      { type: 'text', icon: 'üìÑ', label: 'Text Block', default: { text: 'Enter your text here...', align: 'left', size: '1rem', color: '#94a3b8', width: '100%', height: 'auto', links: [] } },
      { type: 'button', icon: 'üîò', label: 'Button', default: { text: 'Click Me', url: 'https://', newTab: true, bgColor: '#22c55e', textColor: '#ffffff', width: 'auto', height: 'auto' } },
      { type: 'image', icon: 'üñºÔ∏è', label: 'Image', default: { src: '', alt: 'Image', width: '100%', height: 'auto', rounded: '8px' } },
      { type: 'card', icon: 'üÉè', label: 'Card', default: { title: 'Card Title', content: 'Card content goes here...', bgColor: '#0f172a', width: '100%', height: 'auto' } },
      { type: 'hero', icon: 'üé≠', label: 'Hero Section', default: { title: 'Welcome', subtitle: 'This is your hero section', buttonText: 'Get Started', buttonUrl: '#', buttonNewTab: false, bgColor: '#0f172a', textColor: '#e2e8f0', width: '100%', height: 'auto' } },
      { type: 'iframe', icon: 'üåê', label: 'Embed', default: { src: '', width: '100%', height: '400px' } },
      { type: 'footer', icon: 'ü¶∂', label: 'Footer', default: { text: '¬© 2024 Your Company. All rights reserved.', links: [{text: 'Privacy', url: '#'}, {text: 'Terms', url: '#'}], bgColor: '#0f172a', width: '100%', height: 'auto' } },
      { type: 'spacer', icon: '‚ÜïÔ∏è', label: 'Spacer', default: { height: 40, width: '100%' } }
    ];

    let siteData = {
      title: 'My Website',
      domain: '',
      bgColor: '#020617',
      pages: [
        { id: 'home', name: 'Home', isHome: true, elements: [] }
      ]
    };
    
    let currentPageId = 'home';
    let selectedId = null;
    let draggedComponent = null;
    let draggedElement = null;
    let draggedElementWrapper = null;
    let isResizing = false;
    let sidebarTab = 'components'; // 'components', 'pages', 'settings'
    let isPublishing = false;

    // Load from cookie
    const savedData = getCookie('sitebuilder_data');
    if (savedData) {
      try {
        const parsed = JSON.parse(savedData);
        siteData = { ...siteData, ...parsed };
        currentPageId = siteData.pages.find(p => p.isHome)?.id || siteData.pages[0]?.id || 'home';
      } catch(e) {
        console.error('Failed to load saved data');
      }
    }

    if (!uuid || !username) {
      content.innerHTML = `
        <div class="login-required">
          <div class="login-card">
            <div class="login-icon">üé®</div>
            <h1>Access Required</h1>
            <p>Please log in to access SiteBuilder Pro.</p>
            <a href="/login.html" class="login-btn">Sign In</a>
          </div>
        </div>
      `;
    } else {
      renderBuilder();
    }

    function saveToCookie() {
      setCookie('sitebuilder_data', JSON.stringify(siteData));
    }

    function renderBuilder() {
      content.innerHTML = `
        <div id="app">
          <header class="header">
            <div class="header-left">
              <div class="logo">üé® SiteBuilder</div>
            </div>
            <a class="site-title-link" onclick="goHome()">${siteData.title}</a>
            <div class="header-actions">
              <button class="btn" onclick="togglePreview()">üëÅÔ∏è Preview</button>
              <button class="btn" onclick="clearCanvas()">üóëÔ∏è Clear</button>
              <button class="btn" onclick="exportCode()">üì§ Export</button>
              <button class="btn btn-primary" onclick="publishSite()" id="publishBtn" ${isPublishing ? 'disabled' : ''}>
                ${isPublishing ? '‚è≥ Publishing...' : 'üöÄ Publish'}
              </button>
            </div>
          </header>

          <aside class="sidebar" id="sidebar">
            <div class="sidebar-tabs">
              <button class="sidebar-tab ${sidebarTab === 'components' ? 'active' : ''}" onclick="switchSidebarTab('components')">üß© Components</button>
              <button class="sidebar-tab ${sidebarTab === 'pages' ? 'active' : ''}" onclick="switchSidebarTab('pages')">üìë Pages</button>
              <button class="sidebar-tab ${sidebarTab === 'settings' ? 'active' : ''}" onclick="switchSidebarTab('settings')">‚öôÔ∏è Settings</button>
            </div>
            <div class="sidebar-content" id="sidebarContent">
              ${renderSidebarContent()}
            </div>
          </aside>

          <main class="canvas-container">
            <div class="canvas" id="canvas" style="background: ${siteData.bgColor};">
              <div class="canvas-empty" id="emptyState">
                <div class="canvas-empty-icon">üì¶</div>
                <h2>Drag components here</h2>
                <p>Start building your page by dragging components from the sidebar</p>
              </div>
            </div>
          </main>

          <aside class="properties" id="propertiesPanel">
            ${renderPropertiesPanel()}
          </aside>
        </div>
      `;

      initializeDragAndDrop();
      renderCurrentPage();
      initializeElementDragAndDrop();
    }

    function renderSidebarContent() {
      if (sidebarTab === 'pages') {
        return `
          <div class="sidebar-title">Page Management</div>
          <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 20px;">
            Drag pages to reorder. Star marks the homepage.
          </p>
          <ul class="page-list" id="pageList">
            ${siteData.pages.map((page, index) => `
              <li class="page-list-item ${page.id === currentPageId ? 'active' : ''} ${page.isHome ? 'home' : ''}" 
                  draggable="true" data-index="${index}" data-page-id="${page.id}">
                <input type="text" class="page-list-name" value="${page.name}" 
                       onchange="renamePage('${page.id}', this.value)"
                       onclick="event.stopPropagation(); switchPage('${page.id}')">
                <div class="page-list-actions">
                  <button class="page-action-btn ${page.isHome ? 'active' : ''}" 
                          onclick="event.stopPropagation(); setHomePage('${page.id}')" title="Set as Homepage">‚≠ê</button>
                  ${siteData.pages.length > 1 ? `<button class="page-action-btn" onclick="event.stopPropagation(); deletePage('${page.id}')" title="Delete Page">üóëÔ∏è</button>` : ''}
                </div>
              </li>
            `).join('')}
          </ul>
          <button class="add-page-btn" onclick="addPage()">+ Add New Page</button>
        `;
      } else if (sidebarTab === 'settings') {
        const publishUrl = siteData.domain ? `https://hc.curtishub.com?${siteData.domain}` : '';
        return `
          <div class="sidebar-title">Site Settings</div>
          <div class="property-group">
            <label class="property-label">Site Title</label>
            <input type="text" class="property-input" value="${siteData.title}" 
                   oninput="updateSiteTitle(this.value)">
          </div>
          <div class="property-group">
            <label class="property-label">Domain Name</label>
            <input type="text" class="property-input" value="${siteData.domain || ''}" 
                   oninput="updateSiteDomain(this.value)"
                   placeholder="yourdomain">
            <small style="color: var(--text-muted); font-size: 0.8rem; margin-top: 5px; display: block;">
              Your site will be available at: https://hc.curtishub.com?yourdomain
            </small>
            ${publishUrl ? `
              <div class="publish-url">
                <strong>Published URL:</strong><br>
                <a href="${publishUrl}" target="_blank">${publishUrl}</a>
              </div>
            ` : ''}
          </div>
          <div class="property-group">
            <label class="property-label">Background Color</label>
            <div class="color-picker-wrapper">
              <input type="color" class="color-picker" value="${rgbToHex(siteData.bgColor)}" 
                     oninput="updateSiteBgColor(this.value)">
              <input type="text" class="property-input" value="${siteData.bgColor}" 
                     oninput="updateSiteBgColor(this.value)" style="flex: 1;">
            </div>
          </div>
        `;
      } else {
        return `
          <div class="sidebar-title">Components</div>
          <div class="component-grid">
            ${components.map(comp => `
              <div class="component-item" draggable="true" data-type="${comp.type}">
                <div class="component-icon">${comp.icon}</div>
                <div class="component-label">${comp.label}</div>
              </div>
            `).join('')}
          </div>
        `;
      }
    }

    function renderPropertiesPanel() {
      const element = getCurrentPage().elements.find(e => e.id === selectedId);
      if (!element) {
        return `
          <div class="no-selection">
            <div style="font-size: 3rem; margin-bottom: 15px;">üñ±Ô∏è</div>
            <p>Select an element to edit its properties</p>
          </div>
        `;
      }

      return renderElementProperties(element);
    }

    function renderElementProperties(element) {
      const { type, props, id } = element;
      let html = `<div class="properties-title">Edit ${type.charAt(0).toUpperCase() + type.slice(1)}</div>`;

      if (type === 'heading') {
        html += `
          <div class="property-group">
            <label class="property-label">Text Content</label>
            <input type="text" class="property-input" value="${props.text}" oninput="updateProp('${id}', 'text', this.value)">
          </div>
          <div class="property-group">
            <label class="property-label">Heading Tag</label>
            <select class="property-select" onchange="updateProp('${id}', 'tag', this.value)">
              <option value="h1" ${props.tag === 'h1' ? 'selected' : ''}>H1</option>
              <option value="h2" ${props.tag === 'h2' ? 'selected' : ''}>H2</option>
              <option value="h3" ${props.tag === 'h3' ? 'selected' : ''}>H3</option>
            </select>
          </div>
          <div class="property-row">
            <div>
              <label class="property-label">Font Size</label>
              <input type="text" class="property-input" value="${props.size}" oninput="updateProp('${id}', 'size', this.value)">
            </div>
            <div>
              <label class="property-label">Text Color</label>
              <div class="color-picker-wrapper">
                <input type="color" class="color-picker" value="${rgbToHex(props.color)}" oninput="updateProp('${id}', 'color', this.value)">
                <input type="text" class="property-input" value="${props.color}" oninput="updateProp('${id}', 'color', this.value)" style="flex: 1;">
              </div>
            </div>
          </div>
          <div class="property-group">
            <label class="property-label">Alignment</label>
            <select class="property-select" onchange="updateProp('${id}', 'align', this.value)">
              <option value="left" ${props.align === 'left' ? 'selected' : ''}>Left</option>
              <option value="center" ${props.align === 'center' ? 'selected' : ''}>Center</option>
              <option value="right" ${props.align === 'right' ? 'selected' : ''}>Right</option>
            </select>
          </div>
        `;
      } else if (type === 'text') {
        html += `
          <div class="property-group">
            <label class="property-label">Text Content</label>
            <textarea class="property-textarea" oninput="updateProp('${id}', 'text', this.value)">${props.text}</textarea>
          </div>
          <div class="link-editor">
            <label class="property-label">Add Link</label>
            <div class="property-row">
              <input type="text" class="property-input" id="linkText" placeholder="Text to link">
              <input type="text" class="property-input" id="linkUrl" placeholder="URL">
            </div>
            <button class="btn btn-primary" style="margin-top: 10px; width: 100%;" onclick="addLink('${id}')">Add Link</button>
            ${props.links && props.links.length > 0 ? `
              <div style="margin-top: 10px;">
                <label class="property-label">Current Links:</label>
                ${props.links.map((l, i) => `
                  <div style="display: flex; justify-content: space-between; align-items: center; padding: 5px; background: var(--bg); border-radius: 4px; margin-top: 5px;">
                    <span style="font-size: 0.85rem;">${l.text} ‚Üí ${l.url}</span>
                    <button class="btn-danger" style="padding: 2px 8px; font-size: 0.8rem;" onclick="removeLink('${id}', ${i})">Remove</button>
                  </div>
                `).join('')}
              </div>
            ` : ''}
          </div>
          <div class="property-row" style="margin-top: 15px;">
            <div>
              <label class="property-label">Font Size</label>
              <input type="text" class="property-input" value="${props.size}" oninput="updateProp('${id}', 'size', this.value)">
            </div>
            <div>
              <label class="property-label">Text Color</label>
              <div class="color-picker-wrapper">
                <input type="color" class="color-picker" value="${rgbToHex(props.color)}" oninput="updateProp('${id}', 'color', this.value)">
                <input type="text" class="property-input" value="${props.color}" oninput="updateProp('${id}', 'color', this.value)" style="flex: 1;">
              </div>
            </div>
          </div>
        `;
      } else if (type === 'button') {
        html += `
          <div class="property-group">
            <label class="property-label">Button Text</label>
            <input type="text" class="property-input" value="${props.text}" oninput="updateProp('${id}', 'text', this.value)">
          </div>
          <div class="property-group">
            <label class="property-label">URL</label>
            <input type="text" class="property-input" value="${props.url}" oninput="updateProp('${id}', 'url', this.value)">
          </div>
          <div class="property-group">
            <label class="property-label">
              <input type="checkbox" ${props.newTab ? 'checked' : ''} onchange="updateProp('${id}', 'newTab', this.checked)" style="margin-right: 8px;">
              Open in new tab
            </label>
          </div>
          <div class="property-row">
            <div>
              <label class="property-label">Button Color</label>
              <div class="color-picker-wrapper">
                <input type="color" class="color-picker" value="${rgbToHex(props.bgColor)}" oninput="updateProp('${id}', 'bgColor', this.value)">
                <input type="text" class="property-input" value="${props.bgColor}" oninput="updateProp('${id}', 'bgColor', this.value)" style="flex: 1;">
              </div>
            </div>
            <div>
              <label class="property-label">Text Color</label>
              <div class="color-picker-wrapper">
                <input type="color" class="color-picker" value="${rgbToHex(props.textColor)}" oninput="updateProp('${id}', 'textColor', this.value)">
                <input type="text" class="property-input" value="${props.textColor}" oninput="updateProp('${id}', 'textColor', this.value)" style="flex: 1;">
              </div>
            </div>
          </div>
        `;
      } else if (type === 'image') {
        html += `
          <div class="property-group">
            <label class="property-label">Image URL</label>
            <input type="text" class="property-input" value="${props.src}" oninput="updateProp('${id}', 'src', this.value)">
          </div>
          <div class="property-group">
            <label class="property-label">Alt Text</label>
            <input type="text" class="property-input" value="${props.alt}" oninput="updateProp('${id}', 'alt', this.value)">
          </div>
          <div class="property-group">
            <label class="property-label">Border Radius</label>
            <input type="text" class="property-input" value="${props.rounded}" oninput="updateProp('${id}', 'rounded', this.value)">
          </div>
        `;
      } else if (type === 'card') {
        html += `
          <div class="property-group">
            <label class="property-label">Title</label>
            <input type="text" class="property-input" value="${props.title}" oninput="updateProp('${id}', 'title', this.value)">
          </div>
          <div class="property-group">
            <label class="property-label">Content</label>
            <textarea class="property-textarea" oninput="updateProp('${id}', 'content', this.value)">${props.content}</textarea>
          </div>
          <div class="property-group">
            <label class="property-label">Background Color</label>
            <div class="color-picker-wrapper">
              <input type="color" class="color-picker" value="${rgbToHex(props.bgColor)}" oninput="updateProp('${id}', 'bgColor', this.value)">
              <input type="text" class="property-input" value="${props.bgColor}" oninput="updateProp('${id}', 'bgColor', this.value)" style="flex: 1;">
            </div>
          </div>
        `;
      } else if (type === 'hero') {
        html += `
          <div class="property-group">
            <label class="property-label">Title</label>
            <input type="text" class="property-input" value="${props.title}" oninput="updateProp('${id}', 'title', this.value)">
          </div>
          <div class="property-group">
            <label class="property-label">Subtitle</label>
            <input type="text" class="property-input" value="${props.subtitle}" oninput="updateProp('${id}', 'subtitle', this.value)">
          </div>
          <div class="property-group">
            <label class="property-label">Button Text</label>
            <input type="text" class="property-input" value="${props.buttonText}" oninput="updateProp('${id}', 'buttonText', this.value)">
          </div>
          <div class="property-group">
            <label class="property-label">Button URL</label>
            <input type="text" class="property-input" value="${props.buttonUrl || '#'}" oninput="updateProp('${id}', 'buttonUrl', this.value)">
          </div>
          <div class="property-group">
            <label class="property-label">
              <input type="checkbox" ${props.buttonNewTab ? 'checked' : ''} onchange="updateProp('${id}', 'buttonNewTab', this.checked)" style="margin-right: 8px;">
              Open button in new tab
            </label>
          </div>
          <div class="property-row">
            <div>
              <label class="property-label">Background Color</label>
              <div class="color-picker-wrapper">
                <input type="color" class="color-picker" value="${rgbToHex(props.bgColor)}" oninput="updateProp('${id}', 'bgColor', this.value)">
                <input type="text" class="property-input" value="${props.bgColor}" oninput="updateProp('${id}', 'bgColor', this.value)" style="flex: 1;">
              </div>
            </div>
            <div>
              <label class="property-label">Text Color</label>
              <div class="color-picker-wrapper">
                <input type="color" class="color-picker" value="${rgbToHex(props.textColor)}" oninput="updateProp('${id}', 'textColor', this.value)">
                <input type="text" class="property-input" value="${props.textColor}" oninput="updateProp('${id}', 'textColor', this.value)" style="flex: 1;">
              </div>
            </div>
          </div>
        `;
      } else if (type === 'iframe') {
        html += `
          <div class="property-group">
            <label class="property-label">Embed URL</label>
            <input type="text" class="property-input" value="${props.src}" oninput="updateProp('${id}', 'src', this.value)">
          </div>
          <div class="property-group">
            <label class="property-label">Height</label>
            <input type="text" class="property-input" value="${props.height}" oninput="updateProp('${id}', 'height', this.value)">
          </div>
        `;
      } else if (type === 'footer') {
        html += `
          <div class="property-group">
            <label class="property-label">Copyright Text</label>
            <input type="text" class="property-input" value="${props.text}" oninput="updateProp('${id}', 'text', this.value)">
          </div>
          <div class="link-editor">
            <label class="property-label">Add Footer Link</label>
            <div class="property-row">
              <input type="text" class="property-input" id="footerLinkText" placeholder="Link Text">
              <input type="text" class="property-input" id="footerLinkUrl" placeholder="URL">
            </div>
            <button class="btn btn-primary" style="margin-top: 10px; width: 100%;" onclick="addFooterLink('${id}')">Add Link</button>
            ${props.links && props.links.length > 0 ? `
              <div style="margin-top: 10px;">
                ${props.links.map((l, i) => `
                  <div style="display: flex; justify-content: space-between; align-items: center; padding: 5px; background: var(--bg); border-radius: 4px; margin-top: 5px;">
                    <span style="font-size: 0.85rem;">${l.text} ‚Üí ${l.url}</span>
                    <button class="btn-danger" style="padding: 2px 8px; font-size: 0.8rem;" onclick="removeFooterLink('${id}', ${i})">Remove</button>
                  </div>
                `).join('')}
              </div>
            ` : ''}
          </div>
          <div class="property-group">
            <label class="property-label">Background Color</label>
            <div class="color-picker-wrapper">
              <input type="color" class="color-picker" value="${rgbToHex(props.bgColor)}" oninput="updateProp('${id}', 'bgColor', this.value)">
              <input type="text" class="property-input" value="${props.bgColor}" oninput="updateProp('${id}', 'bgColor', this.value)" style="flex: 1;">
            </div>
          </div>
        `;
      } else if (type === 'spacer') {
        html += `
          <div class="property-group">
            <label class="property-label">Height (px)</label>
            <input type="number" class="property-input" value="${props.height}" oninput="updateProp('${id}', 'height', parseInt(this.value))" min="0" max="500">
          </div>
        `;
      }

      return html;
    }

    function getCurrentPage() {
      return siteData.pages.find(p => p.id === currentPageId) || siteData.pages[0];
    }

    function initializeDragAndDrop() {
      const componentItems = document.querySelectorAll('.component-item');
      const canvas = document.getElementById('canvas');

      componentItems.forEach(item => {
        item.addEventListener('dragstart', (e) => {
          draggedComponent = components.find(c => c.type === item.dataset.type);
          e.dataTransfer.effectAllowed = 'copy';
        });
      });

      canvas.addEventListener('dragover', (e) => {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'copy';
        canvas.classList.add('drag-over');
      });

      canvas.addEventListener('dragleave', () => {
        canvas.classList.remove('drag-over');
      });

      canvas.addEventListener('drop', (e) => {
        e.preventDefault();
        canvas.classList.remove('drag-over');
        if (draggedComponent) {
          addElement(draggedComponent);
          draggedComponent = null;
        }
      });
    }

    function initializeElementDragAndDrop() {
      const canvas = document.getElementById('canvas');
      
      canvas.addEventListener('dragover', (e) => {
        if (draggedElementWrapper) {
          e.preventDefault();
          e.dataTransfer.dropEffect = 'move';
          
          const afterElement = getDragAfterElement(canvas, e.clientY);
          if (afterElement == null) {
            canvas.appendChild(draggedElementWrapper);
          } else {
            canvas.insertBefore(draggedElementWrapper, afterElement);
          }
        }
      });

      canvas.addEventListener('drop', (e) => {
        if (draggedElementWrapper) {
          e.preventDefault();
          draggedElementWrapper.classList.remove('dragging');
          
          // Update the order in siteData
          const newOrder = [];
          canvas.querySelectorAll('.element-wrapper').forEach(wrapper => {
            const id = wrapper.dataset.id;
            const element = getCurrentPage().elements.find(e => e.id === id);
            if (element) newOrder.push(element);
          });
          
          getCurrentPage().elements = newOrder;
          saveToCookie();
          
          draggedElementWrapper = null;
          draggedElement = null;
        }
      });
    }

    function getDragAfterElement(container, y) {
      const draggableElements = [...container.querySelectorAll('.element-wrapper:not(.dragging)')];
      
      return draggableElements.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height / 2;
        if (offset < 0 && offset > closest.offset) {
          return { offset: offset, element: child };
        } else {
          return closest;
        }
      }, { offset: Number.NEGATIVE_INFINITY }).element;
    }

    function renderCurrentPage() {
      const canvas = document.getElementById('canvas');
      const page = getCurrentPage();
      
      // Clear existing elements except empty state
      Array.from(canvas.children).forEach(child => {
        if (child.id !== 'emptyState') child.remove();
      });

      if (page.elements.length === 0) {
        document.getElementById('emptyState').style.display = 'block';
      } else {
        document.getElementById('emptyState').style.display = 'none';
        page.elements.forEach(el => renderElement(el, canvas));
      }
    }

    function addElement(component) {
      const page = getCurrentPage();
      const id = Date.now().toString();
      const element = {
        id,
        type: component.type,
        props: { ...component.default },
        parentId: null
      };
      
      page.elements.push(element);
      renderElement(element, document.getElementById('canvas'));
      updateEmptyState();
      selectElement(id);
      saveToCookie();
    }

    function renderElement(element, container, isSideElement = false) {
      if (element.type === 'header' || element.type === 'footer') {
        element.locked = true;
      }

      const wrapper = document.createElement('div');
      wrapper.className = 'element-wrapper';
      wrapper.dataset.id = element.id;
      
      // Only main elements (not side elements) can be dragged for reordering
      if (!element.locked && !isSideElement && !element.parentId) {
        const dragHandle = document.createElement('div');
        dragHandle.className = 'drag-handle';
        dragHandle.innerHTML = '‚ãÆ‚ãÆ';
        dragHandle.draggable = true;
        dragHandle.title = 'Drag to reorder';
        
        dragHandle.addEventListener('dragstart', (e) => {
          draggedElement = element;
          draggedElementWrapper = wrapper;
          wrapper.classList.add('dragging');
          e.dataTransfer.effectAllowed = 'move';
          e.stopPropagation();
        });
        
        dragHandle.addEventListener('dragend', () => {
          wrapper.classList.remove('dragging');
        });
        
        wrapper.appendChild(dragHandle);
      }

      const div = document.createElement('div');
      div.className = `canvas-element ${element.locked ? 'locked' : ''} ${selectedId === element.id ? 'selected' : ''}`;
      div.dataset.id = element.id;
      div.style.width = element.props.width || '100%';
      div.style.height = element.props.height || 'auto';
      
      // Only show SE resize handle
      div.innerHTML = `
        <div class="resize-handle se" data-handle="se"></div>
        <div class="element-actions">
          <button class="element-action-btn" onclick="moveUp('${element.id}')" title="Move Up">‚Üë</button>
          <button class="element-action-btn" onclick="moveDown('${element.id}')" title="Move Down">‚Üì</button>
          <button class="element-action-btn delete" onclick="deleteElement('${element.id}')" title="Delete">√ó</button>
        </div>
        <div class="element-content">
          ${renderElementContent(element)}
        </div>
      `;

      div.addEventListener('click', (e) => {
        if (!e.target.closest('.element-actions') && !e.target.classList.contains('resize-handle')) {
          selectElement(element.id);
        }
      });

      setupResizeHandles(div, element);

      wrapper.appendChild(div);

      // Handle side-by-side elements
      if (!isSideElement && !element.parentId) {
        const page = getCurrentPage();
        const sideElement = page.elements.find(e => e.parentId === element.id);
        
        if (sideElement) {
          // Create container for side-by-side elements
          const sideContainer = document.createElement('div');
          sideContainer.className = 'side-element-container';
          
          // Move current element into container
          sideContainer.appendChild(div);
          
          // Render side element
          const sideWrapper = document.createElement('div');
          sideWrapper.className = 'element-wrapper';
          sideWrapper.style.flex = '1';
          sideWrapper.style.marginBottom = '0';
          
          const sideDiv = document.createElement('div');
          sideDiv.className = `canvas-element ${sideElement.locked ? 'locked' : ''} ${selectedId === sideElement.id ? 'selected' : ''}`;
          sideDiv.dataset.id = sideElement.id;
          sideDiv.style.width = sideElement.props.width || '100%';
          sideDiv.style.height = sideElement.props.height || 'auto';
          
          sideDiv.innerHTML = `
            <div class="resize-handle se" data-handle="se"></div>
            <div class="element-actions">
              <button class="element-action-btn" onclick="moveUp('${sideElement.id}')" title="Move Up">‚Üë</button>
              <button class="element-action-btn" onclick="moveDown('${sideElement.id}')" title="Move Down">‚Üì</button>
              <button class="element-action-btn delete" onclick="deleteElement('${sideElement.id}')" title="Delete">√ó</button>
            </div>
            <div class="element-content">
              ${renderElementContent(sideElement)}
            </div>
          `;
          
          sideDiv.addEventListener('click', (e) => {
            if (!e.target.closest('.element-actions') && !e.target.classList.contains('resize-handle')) {
              selectElement(sideElement.id);
            }
          });
          
          setupResizeHandles(sideDiv, sideElement);
          sideWrapper.appendChild(sideDiv);
          sideContainer.appendChild(sideWrapper);
          
          // Add delete button for the pair
          const deletePairBtn = document.createElement('button');
          deletePairBtn.className = 'delete-side-btn';
          deletePairBtn.innerHTML = '√ó';
          deletePairBtn.title = 'Remove side element';
          deletePairBtn.onclick = () => deleteSideElement(element.id);
          wrapper.appendChild(deletePairBtn);
          
          wrapper.appendChild(sideContainer);
        } else {
          // No side element yet - add button to create one
          const addSideBtn = document.createElement('button');
          addSideBtn.className = 'delete-side-btn';
          addSideBtn.innerHTML = '+';
          addSideBtn.style.background = 'var(--accent)';
          addSideBtn.title = 'Add element beside';
          addSideBtn.onclick = () => addSideElement(element.id);
          wrapper.appendChild(addSideBtn);
        }
      }

      container.appendChild(wrapper);
    }

    function addSideElement(parentId) {
      const page = getCurrentPage();
      
      // Check if already has side element
      if (page.elements.find(e => e.parentId === parentId)) {
        showToast('Already has a side element (max 2)', 'error');
        return;
      }

      // Show component picker or just add a default text block
      const component = components.find(c => c.type === 'text'); // Default to text
      const id = Date.now().toString();
      const element = {
        id,
        type: component.type,
        props: { ...component.default },
        parentId: parentId
      };
      
      page.elements.push(element);
      renderCurrentPage();
      selectElement(id);
      saveToCookie();
      showToast('Side element added', 'success');
    }

    function deleteSideElement(parentId) {
      const page = getCurrentPage();
      const sideElement = page.elements.find(e => e.parentId === parentId);
      
      if (sideElement) {
        if (selectedId === sideElement.id) {
          selectedId = null;
        }
        page.elements = page.elements.filter(e => e.id !== sideElement.id);
        renderCurrentPage();
        saveToCookie();
        showToast('Side element removed', 'success');
      }
    }

    function setupResizeHandles(element, data) {
      const handle = element.querySelector('.resize-handle.se');
      if (!handle) return;
      
      handle.addEventListener('mousedown', (e) => {
        e.stopPropagation();
        e.preventDefault();
        isResizing = true;
        const startX = e.clientX;
        const startY = e.clientY;
        const startWidth = element.offsetWidth;
        const startHeight = element.offsetHeight;

        function onMouseMove(e) {
          if (!isResizing) return;
          
          const deltaX = e.clientX - startX;
          const deltaY = e.clientY - startY;
          
          const newWidth = startWidth + deltaX;
          const newHeight = startHeight + deltaY;

          if (newWidth > 200) {
            element.style.width = newWidth + 'px';
            data.props.width = newWidth + 'px';
          }
          if (newHeight > 50) {
            element.style.height = newHeight + 'px';
            data.props.height = newHeight + 'px';
          }
        }

        function onMouseUp() {
          isResizing = false;
          saveToCookie();
          document.removeEventListener('mousemove', onMouseMove);
          document.removeEventListener('mouseup', onMouseUp);
        }

        document.addEventListener('mousemove', onMouseMove);
        document.addEventListener('mouseup', onMouseUp);
      });
    }

    function renderElementContent(element) {
      const { type, props } = element;
      
      switch(type) {
        case 'heading':
          const HeadingTag = props.tag || 'h2';
          return `<${HeadingTag} style="text-align: ${props.align}; font-size: ${props.size}; color: ${props.color}; margin: 0;">${props.text}</${HeadingTag}>`;
        
        case 'text':
          let textContent = props.text;
          if (props.links && props.links.length > 0) {
            props.links.forEach(link => {
              textContent = textContent.replace(
                new RegExp(link.text, 'g'), 
                `<a href="${link.url}" target="_blank" rel="noopener noreferrer">${link.text}</a>`
              );
            });
          }
          return `<p style="text-align: ${props.align}; font-size: ${props.size}; color: ${props.color}; margin: 0; line-height: 1.6;">${textContent}</p>`;
        
        case 'button':
          const target = props.newTab ? 'target="_blank" rel="noopener noreferrer"' : '';
          return `
            <div class="el-button">
              <a href="${props.url}" ${target} class="btn-preview" style="background-color: ${props.bgColor}; color: ${props.textColor};">
                ${props.text}
              </a>
            </div>
          `;
        
        case 'image':
          if (!props.src) {
            return `<div style="padding: 40px; text-align: center; background: var(--bg); border-radius: 8px; color: var(--text-muted); border: 2px dashed var(--border);">No Image URL set</div>`;
          }
          return `<img src="${props.src}" alt="${props.alt}" style="width: 100%; height: 100%; object-fit: cover; border-radius: ${props.rounded}; display: block;">`;
        
        case 'card':
          return `
            <div class="el-card" style="background: ${props.bgColor}; height: 100%;">
              <h3 style="margin: 0 0 10px 0; color: var(--text);">${props.title}</h3>
              <p style="margin: 0; color: var(--text-muted); line-height: 1.6;">${props.content}</p>
            </div>
          `;
        
        case 'hero':
          const heroTarget = props.buttonNewTab ? 'target="_blank" rel="noopener noreferrer"' : '';
          return `
            <div class="el-hero" style="background: ${props.bgColor}; height: 100%;">
              <h1 style="color: ${props.textColor}; margin: 0 0 20px 0;">${props.title}</h1>
              <p style="color: ${props.textColor}99; margin: 0 0 30px 0; font-size: 1.2rem;">${props.subtitle}</p>
              <a href="${props.buttonUrl || '#'}" ${heroTarget} class="btn-preview" style="background: var(--accent); color: white; padding: 14px 32px; border: none; border-radius: 8px; font-size: 1.1rem; cursor: pointer; text-decoration: none; display: inline-block;">${props.buttonText}</a>
            </div>
          `;

        case 'iframe':
          if (!props.src) {
            return `<div style="padding: 40px; text-align: center; background: var(--bg); border-radius: 8px; color: var(--text-muted); border: 2px dashed var(--border);">Enter iframe URL</div>`;
          }
          return `<div class="el-iframe" style="width: 100%; height: 100%;"><iframe src="${props.src}" style="width: 100%; height: ${props.height}; border: none; border-radius: 8px;"></iframe></div>`;

        case 'footer':
          const footerLinks = props.links.map(l => `<a href="${l.url}" style="color: var(--accent); text-decoration: none; margin: 0 10px;">${l.text}</a>`).join('');
          return `
            <div class="el-footer" style="background: ${props.bgColor}; height: 100%;">
              <p style="margin: 0 0 10px 0; color: var(--text-muted);">${props.text}</p>
              <div>${footerLinks}</div>
            </div>
          `;
        
        case 'spacer':
          return `<div style="height: ${props.height}px; width: 100%;"></div>`;
        
        default:
          return '<div>Unknown Component</div>';
      }
    }

    function updateEmptyState() {
      const emptyState = document.getElementById('emptyState');
      const page = getCurrentPage();
      if (emptyState) {
        emptyState.style.display = page.elements.length === 0 ? 'block' : 'none';
      }
    }

    function selectElement(id) {
      selectedId = id;
      document.querySelectorAll('.canvas-element').forEach(el => {
        el.classList.remove('selected');
      });
      
      const el = document.querySelector(`.canvas-element[data-id="${id}"]`);
      if (el) el.classList.add('selected');
      
      // Re-render properties
      const panel = document.getElementById('propertiesPanel');
      const element = getCurrentPage().elements.find(e => e.id === selectedId);
      if (element) {
        panel.innerHTML = renderElementProperties(element);
      } else {
        panel.innerHTML = `
          <div class="no-selection">
            <div style="font-size: 3rem; margin-bottom: 15px;">üñ±Ô∏è</div>
            <p>Select an element to edit its properties</p>
          </div>
        `;
      }
    }

    function rgbToHex(color) {
      if (!color || color.startsWith('#')) return color || '#000000';
      if (color.startsWith('rgb')) {
        const rgb = color.match(/\d+/g);
        if (rgb) {
          return '#' + rgb.map(x => {
            const hex = parseInt(x).toString(16);
            return hex.length === 1 ? '0' + hex : hex;
          }).join('');
        }
      }
      return '#000000';
    }

    window.updateProp = function(id, prop, value) {
      const page = getCurrentPage();
      const element = page.elements.find(e => e.id === id);
      if (element) {
        element.props[prop] = value;
        refreshElement(element);
        saveToCookie();
      }
    };

    window.addLink = function(id) {
      const text = document.getElementById('linkText').value;
      const url = document.getElementById('linkUrl').value;
      if (text && url) {
        const page = getCurrentPage();
        const element = page.elements.find(e => e.id === id);
        if (!element.props.links) element.props.links = [];
        element.props.links.push({ text, url });
        document.getElementById('linkText').value = '';
        document.getElementById('linkUrl').value = '';
        refreshElement(element);
        selectElement(id);
        saveToCookie();
      }
    };

    window.removeLink = function(id, index) {
      const page = getCurrentPage();
      const element = page.elements.find(e => e.id === id);
      element.props.links.splice(index, 1);
      refreshElement(element);
      selectElement(id);
      saveToCookie();
    };

    window.addFooterLink = function(id) {
      const text = document.getElementById('footerLinkText').value;
      const url = document.getElementById('footerLinkUrl').value;
      if (text && url) {
        const page = getCurrentPage();
        const element = page.elements.find(e => e.id === id);
        if (!element.props.links) element.props.links = [];
        element.props.links.push({ text, url });
        document.getElementById('footerLinkText').value = '';
        document.getElementById('footerLinkUrl').value = '';
        refreshElement(element);
        selectElement(id);
        saveToCookie();
      }
    };

    window.removeFooterLink = function(id, index) {
      const page = getCurrentPage();
      const element = page.elements.find(e => e.id === id);
      element.props.links.splice(index, 1);
      refreshElement(element);
      selectElement(id);
      saveToCookie();
    };

    function refreshElement(element) {
      const el = document.querySelector(`.canvas-element[data-id="${element.id}"]`);
      if (el) {
        el.querySelector('.element-content').innerHTML = renderElementContent(element);
      }
    }

    window.deleteElement = function(id) {
      const page = getCurrentPage();
      const element = page.elements.find(e => e.id === id);
      
      if (!element) return;
      
      // If this is a parent of a side element, remove the side element too
      if (!element.parentId) {
        const sideElement = page.elements.find(e => e.parentId === id);
        if (sideElement) {
          page.elements = page.elements.filter(e => e.id !== sideElement.id);
        }
      }
      
      // If this is a side element, just remove it
      page.elements = page.elements.filter(e => e.id !== id);
      
      if (selectedId === id) {
        selectedId = null;
        document.getElementById('propertiesPanel').innerHTML = `
          <div class="no-selection">
            <div style="font-size: 3rem; margin-bottom: 15px;">üñ±Ô∏è</div>
            <p>Select an element to edit its properties</p>
          </div>
        `;
      }
      
      renderCurrentPage();
      updateEmptyState();
      saveToCookie();
    };

    window.moveUp = function(id) {
      const page = getCurrentPage();
      const idx = page.elements.findIndex(e => e.id === id);
      if (idx > 0) {
        [page.elements[idx], page.elements[idx - 1]] = [page.elements[idx - 1], page.elements[idx]];
        renderCurrentPage();
        saveToCookie();
      }
    };

    window.moveDown = function(id) {
      const page = getCurrentPage();
      const idx = page.elements.findIndex(e => e.id === id);
      if (idx < page.elements.length - 1) {
        [page.elements[idx], page.elements[idx + 1]] = [page.elements[idx + 1], page.elements[idx]];
        renderCurrentPage();
        saveToCookie();
      }
    };

    window.clearCanvas = function() {
      if (confirm('Are you sure you want to clear all elements?')) {
        const page = getCurrentPage();
        page.elements = [];
        selectedId = null;
        renderCurrentPage();
        document.getElementById('propertiesPanel').innerHTML = `
          <div class="no-selection">
            <div style="font-size: 3rem; margin-bottom: 15px;">üñ±Ô∏è</div>
            <p>Select an element to edit its properties</p>
          </div>
        `;
        saveToCookie();
        showToast('Canvas cleared', 'success');
      }
    };

    window.togglePreview = function() {
      document.body.classList.toggle('preview-mode');
      const btn = event.target;
      const isPreview = document.body.classList.contains('preview-mode');
      btn.textContent = isPreview ? '‚úèÔ∏è Edit' : 'üëÅÔ∏è Preview';
      
      // Show/hide watermark
      const watermark = document.querySelector('.watermark');
      if (watermark) {
        watermark.style.display = isPreview ? 'block' : 'none';
      }
    };

    // PUBLISH FUNCTION - Uses upsert to avoid RLS issues
    window.publishSite = async function() {
      if (!siteData.domain || siteData.domain.trim() === '') {
        showToast('Please set a domain name in Settings first', 'error');
        switchSidebarTab('settings');
        return;
      }

      isPublishing = true;
      const btn = document.getElementById('publishBtn');
      if (btn) {
        btn.disabled = true;
        btn.textContent = '‚è≥ Publishing...';
      }

      try {
        const html = generateHTML();
        const domain = siteData.domain.trim().toLowerCase().replace(/[^a-z0-9-]/g, '-').replace(/-+/g, '-').replace(/^-|-$/g, '');
        
        // Try upsert first (insert or update)
        const { data, error } = await supabase
          .from('published_sites')
          .upsert({
            domain: domain,
            html_content: html,
            site_data: siteData,
            user_id: uuid,
            updated_at: new Date().toISOString()
          }, {
            onConflict: 'domain'
          });

        if (error) {
          // If upsert fails due to RLS, try direct insert with conflict handling
          if (error.code === '42501') {
            // Check if exists first
            const { data: existing } = await supabase
              .from('published_sites')
              .select('domain')
              .eq('domain', domain)
              .maybeSingle();
            
            if (existing) {
              // Update using RPC or different method
              const { error: updateError } = await supabase
                .rpc('update_published_site', {
                  p_domain: domain,
                  p_html_content: html,
                  p_site_data: siteData,
                  p_user_id: uuid
                });
              
              if (updateError) throw updateError;
            } else {
              // Insert new
              const { error: insertError } = await supabase
                .from('published_sites')
                .insert({
                  domain: domain,
                  html_content: html,
                  site_data: siteData,
                  user_id: uuid,
                  created_at: new Date().toISOString(),
                  updated_at: new Date().toISOString()
                });
              
              if (insertError) throw insertError;
            }
          } else {
            throw error;
          }
        }

        const publishUrl = `https://hc.curtishub.com?${domain}`;
        showToast(`Site published successfully!`, 'success');
        
        // Show the URL in settings if we're there
        if (sidebarTab === 'settings') {
          document.getElementById('sidebarContent').innerHTML = renderSidebarContent();
        }

      } catch (error) {
        console.error('Publish error:', error);
        showToast('Failed to publish: ' + error.message, 'error');
      } finally {
        isPublishing = false;
        if (btn) {
          btn.disabled = false;
          btn.textContent = 'üöÄ Publish';
        }
      }
    };

    // Alternative publish using edge function (recommended approach)
    window.publishSiteSecure = async function() {
      if (!siteData.domain || siteData.domain.trim() === '') {
        showToast('Please set a domain name in Settings first', 'error');
        switchSidebarTab('settings');
        return;
      }

      isPublishing = true;
      const btn = document.getElementById('publishBtn');
      if (btn) {
        btn.disabled = true;
        btn.textContent = '‚è≥ Publishing...';
      }

      try {
        const html = generateHTML();
        const domain = siteData.domain.trim().toLowerCase().replace(/[^a-z0-9-]/g, '-').replace(/-+/g, '-').replace(/^-|-$/g, '');
        
        // Call edge function for secure publishing
        const { data, error } = await supabase.functions.invoke('publish-site', {
          body: {
            domain: domain,
            html_content: html,
            site_data: siteData,
            user_id: uuid
          }
        });

        if (error) throw error;

        const publishUrl = `https://hc.curtishub.com?${domain}`;
        showToast(`Site published successfully!`, 'success');
        
        if (sidebarTab === 'settings') {
          document.getElementById('sidebarContent').innerHTML = renderSidebarContent();
        }

      } catch (error) {
        console.error('Publish error:', error);
        showToast('Failed to publish: ' + error.message, 'error');
      } finally {
        isPublishing = false;
        if (btn) {
          btn.disabled = false;
          btn.textContent = 'üöÄ Publish';
        }
      }
    };

    // Sidebar Tab Management
    window.switchSidebarTab = function(tab) {
      sidebarTab = tab;
      document.getElementById('sidebarContent').innerHTML = renderSidebarContent();
      
      // Update tab styles
      document.querySelectorAll('.sidebar-tab').forEach(t => {
        t.classList.remove('active');
      });
      event.target.classList.add('active');
      
      // Re-initialize drag and drop for pages tab
      if (tab === 'pages') {
        initializePageDragAndDrop();
      }
    };

    function initializePageDragAndDrop() {
      const pageList = document.getElementById('pageList');
      if (!pageList) return;
      
      let draggedItem = null;

      pageList.addEventListener('dragstart', (e) => {
        if (e.target.classList.contains('page-list-item')) {
          draggedItem = e.target;
          e.target.classList.add('dragging');
        }
      });

      pageList.addEventListener('dragend', (e) => {
        if (e.target.classList.contains('page-list-item')) {
          e.target.classList.remove('dragging');
        }
      });

      pageList.addEventListener('dragover', (e) => {
        e.preventDefault();
        const afterElement = getDragAfterElement(pageList, e.clientY);
        if (afterElement == null) {
          pageList.appendChild(draggedItem);
        } else {
          pageList.insertBefore(draggedItem, afterElement);
        }
      });

      pageList.addEventListener('drop', () => {
        const newOrder = [];
        pageList.querySelectorAll('.page-list-item').forEach(item => {
          const pageId = item.dataset.pageId;
          const page = siteData.pages.find(p => p.id === pageId);
          if (page) newOrder.push(page);
        });
        siteData.pages = newOrder;
        saveToCookie();
      });
    }

    // Page Management
    window.switchPage = function(pageId) {
      currentPageId = pageId;
      selectedId = null;
      renderBuilder();
    };

    window.goHome = function() {
      const homePage = siteData.pages.find(p => p.isHome) || siteData.pages[0];
      currentPageId = homePage.id;
      selectedId = null;
      renderBuilder();
      showToast('Switched to home page', 'success');
    };

    window.addPage = function() {
      const id = 'page_' + Date.now();
      const pageNum = siteData.pages.length + 1;
      siteData.pages.push({
        id,
        name: 'Page ' + pageNum,
        isHome: false,
        elements: []
      });
      currentPageId = id;
      saveToCookie();
      renderBuilder();
      showToast('New page created', 'success');
    };

    window.deletePage = function(pageId) {
      if (siteData.pages.length <= 1) {
        showToast('Cannot delete the only page', 'error');
        return;
      }
      
      const page = siteData.pages.find(p => p.id === pageId);
      if (page.isHome) {
        showToast('Cannot delete homepage. Set another page as home first.', 'error');
        return;
      }
      
      if (confirm('Delete this page?')) {
        siteData.pages = siteData.pages.filter(p => p.id !== pageId);
        if (currentPageId === pageId) {
          currentPageId = siteData.pages.find(p => p.isHome)?.id || siteData.pages[0].id;
        }
        saveToCookie();
        renderBuilder();
        showToast('Page deleted', 'success');
      }
    };

    window.renamePage = function(pageId, newName) {
      const page = siteData.pages.find(p => p.id === pageId);
      if (page && newName.trim()) {
        page.name = newName.trim();
        saveToCookie();
        // Update header if current page
        if (pageId === currentPageId) {
          const titleLink = document.querySelector('.site-title-link');
          if (titleLink) titleLink.textContent = siteData.title;
        }
      }
    };

    window.setHomePage = function(pageId) {
      siteData.pages.forEach(p => p.isHome = (p.id === pageId));
      saveToCookie();
      renderBuilder();
      showToast('Homepage updated', 'success');
    };

    // Settings
    window.updateSiteTitle = function(title) {
      siteData.title = title;
      saveToCookie();
      const titleLink = document.querySelector('.site-title-link');
      if (titleLink) titleLink.textContent = title;
      // Update page title
      document.title = title;
    };

    window.updateSiteDomain = function(domain) {
      // Clean domain name - only allow alphanumeric and hyphens
      const cleanDomain = domain.trim().toLowerCase().replace(/[^a-z0-9-]/g, '-').replace(/-+/g, '-').replace(/^-|-$/g, '');
      siteData.domain = cleanDomain;
      saveToCookie();
      // Refresh settings to show updated URL
      if (sidebarTab === 'settings') {
        document.getElementById('sidebarContent').innerHTML = renderSidebarContent();
      }
    };

    window.updateSiteBgColor = function(color) {
      siteData.bgColor = color;
      const canvas = document.getElementById('canvas');
      if (canvas) canvas.style.background = color;
      saveToCookie();
    };

    window.exportCode = function() {
      const html = generateHTML();
      document.getElementById('codeOutput').value = html;
      document.getElementById('codeModal').classList.add('active');
    };

    window.closeModal = function() {
      document.getElementById('codeModal').classList.remove('active');
    };

    window.copyCode = function() {
      const textarea = document.getElementById('codeOutput');
      textarea.select();
      document.execCommand('copy');
      showToast('Code copied to clipboard!', 'success');
    };

    function generateHTML() {
      const isLight = document.documentElement.classList.contains('light');
      const themeClass = isLight ? 'light' : '';
      const showNav = siteData.pages.length > 1;
      
      // Generate navigation if multiple pages
      let navHTML = '';
      if (showNav) {
        const navLinks = siteData.pages.map(page => {
          return `<button onclick="showPage('${page.id}')" class="nav-btn ${page.isHome ? 'active' : ''}" data-page="${page.id}">${page.name}</button>`;
        }).join('');
        navHTML = `
    <nav class="nav">
      ${navLinks}
    </nav>`;
      }

      // Generate all page contents
      const pagesHTML = siteData.pages.map(page => {
        const isHome = page.isHome ? 'home-page' : '';
        const display = page.isHome ? 'block' : 'none';
        const pageContent = page.elements.map(el => {
          const content = renderElementContent(el);
          const width = el.props.width || '100%';
          const height = el.props.height || 'auto';
          
          // Check if has side element
          const sideEl = page.elements.find(e => e.parentId === el.id);
          if (sideEl && !el.parentId) {
            const sideContent = renderElementContent(sideEl);
            const sideWidth = sideEl.props.width || '100%';
            const sideHeight = sideEl.props.height || 'auto';
            return `      <div style="display: flex; gap: 20px; margin-bottom: 20px;">
        <div class="section" style="flex: 1; width: ${width}; height: ${height};">
          ${content}
        </div>
        <div class="section" style="flex: 1; width: ${sideWidth}; height: ${sideHeight};">
          ${sideContent}
        </div>
      </div>`;
          } else if (el.parentId) {
            // Skip side elements as they're rendered with parent
            return '';
          }
          
          return `      <div class="section" style="width: ${width}; height: ${height}; margin-bottom: 20px;">
        ${content}
      </div>`;
        }).join('\n\n');
        
        return `
    <div id="page-${page.id}" class="page-content ${isHome}" style="display: ${display};">
      <div class="container">
${pageContent}
      </div>
    </div>`;
      }).join('');

      return `<!DOCTYPE html>
<html lang="en"${themeClass ? ` class="${themeClass}"` : ''}>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>${siteData.title}</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --bg: ${isLight ? '#f8fafc' : '#020617'};
      --panel: ${isLight ? '#ffffff' : '#0f172a'};
      --text: ${isLight ? '#1e293b' : '#e2e8f0'};
      --text-muted: ${isLight ? '#64748b' : '#94a3b8'};
      --accent: ${isLight ? '#16a34a' : '#22c55e'};
      --border: ${isLight ? '#e2e8f0' : '#1e293b'};
    }
    body {
      font-family: system-ui, -apple-system, sans-serif;
      background: ${siteData.bgColor};
      color: var(--text);
      line-height: 1.6;
    }
    .container { max-width: 1200px; margin: 0 auto; padding: 40px 20px; }
    .section { margin-bottom: 40px; }
    .nav { 
      background: var(--panel); 
      padding: 20px; 
      text-align: center; 
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .nav-btn {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text);
      padding: 8px 16px;
      margin: 0 5px;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .nav-btn:hover, .nav-btn.active {
      background: var(--accent);
      border-color: var(--accent);
      color: white;
    }
    .page-content { display: none; }
    .page-content.home-page { display: block; }
    h1, h2, h3 { color: var(--text); margin-bottom: 20px; }
    p { line-height: 1.6; }
    a { color: var(--accent); }
    .btn {
      display: inline-block;
      padding: 12px 24px;
      text-decoration: none;
      border-radius: 8px;
      font-weight: 600;
      transition: all 0.2s;
      border: none;
      cursor: pointer;
    }
    .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
    img { max-width: 100%; height: auto; display: block; }
    .card {
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 30px;
      margin-bottom: 20px;
    }
    .hero {
      text-align: center;
      padding: 80px 20px;
      border-radius: 16px;
    }
    .hero h1 { font-size: 2.5rem; margin-bottom: 20px; }
    .hero p { font-size: 1.2rem; margin-bottom: 30px; }
    iframe { width: 100%; border: none; border-radius: 8px; }
    .footer {
      border-top: 1px solid var(--border);
      padding: 40px 20px;
      text-align: center;
      margin-top: 40px;
    }
    .watermark {
      position: fixed;
      bottom: 10px;
      right: 10px;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 5px 10px;
      border-radius: 4px;
      font-size: 0.75rem;
      z-index: 9999;
      pointer-events: none;
    }
  </style>
</head>
<body>
${navHTML}
${pagesHTML}

<div class="watermark">Built using hc.curtishub.com</div>

  <script>
    function showPage(pageId) {
      document.querySelectorAll('.page-content').forEach(page => {
        page.style.display = 'none';
      });
      document.getElementById('page-' + pageId).style.display = 'block';
      document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.page === pageId) {
          btn.classList.add('active');
        }
      });
    }
  <\/script>
</body>
</html>`;
    }

    function showToast(message, type) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = `toast ${type}`;
      setTimeout(() => toast.classList.add('show'), 10);
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }

    document.getElementById('codeModal').addEventListener('click', (e) => {
      if (e.target.id === 'codeModal') {
        closeModal();
      }
    });
  </script>
</body>
</html>